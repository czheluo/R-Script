times<-Sys.time()
library('getopt');
options(bitmapType='cairo')
spec = matrix(c(
	'mark','m',1,'character',
	'trt','t',1,'character',
	'out','o',1,'character',
	'num','n',1,'character',
	'pop','p',1,'character',
	'help','h',0,'logical'
	), byrow=TRUE, ncol=4)
opt = getopt(spec)
print_usage <- function(spec=NULL){
	cat(getopt(spec, usage=TRUE));
	cat("Usage example: \n")
	cat("
Usage example:
	Rscript Rqtl-NOCP.r --mark  --out --num --pop

Usage:
	--mark	input sexAver file
	--mark1	input male file
	--mark2	input female file
	--out	out dir
	--help		usage
\n")
	q(status=1);
}
times<-Sys.time()
library('qtl');
if ( !is.null(opt$help) ) { print_usage(spec) }
if ( is.null(opt$mark) ) { print_usage(spec) }
if ( is.null(opt$out) ) { print_usage(spec) }

d<-read.table(opt$mark,head=TRUE,sep=",")
d<-na.omit(d)
colnames(d)[2:3]=c("chr","pos")
chr=unique(d$chr);
for(i in chr){
	pos=(1:length(d$pos[d$chr==i])/2)
	d$start[d$chr==i]=pos
	d$end[d$chr==i]=pos+1
}
print(unique(d$chr))
cols=c("green","blue","grey","white","white")
names(cols)=c("1","2","0","-","5")
chr.len <- tapply(d$end, d$chr, max)
x.brks <- cumsum(chr.len) - chr.len/2
chr.cum.len <- c(0, cumsum(chr.len)[-length(chr.len)])
d$start<-d$start+chr.cum.len[d$chr]
d$end<-d$end+chr.cum.len[d$chr]
names(chr.cum.len) <- names(chr.len)
pdf(paste(opt$out,"pdf",sep="."),height=900,width=1600);
plot(5, type = "n", xlim = c(0, max(d$end)), ylim = c(0,ncol(d) - 4), xaxt = "n",main="Haplotype",xlab=paste("LG",sep=" "),ylab="Samples")
axis(side = 1, at = x.brks, labels = unique(d$chr))
for (i in 4:ncol(d)) {
	if(colnames(d)[i]=="start"|| colnames(d)[i]=="end"){next}
    rect(xleft = d$start, ybottom = i - 5, xright = d$end,ytop = i - 4.6, col = cols[as.character(d[seq(0,length(d[,i]),2),i])], border = NA)
    rect(xleft = d$start, ybottom = i - 4.6, xright = d$end,ytop = i - 4.2, col = cols[as.character(d[seq(1,length(d[,i]),2),i])], border = NA)
    rect(xleft = d$start, ybottom = i - 4.2, xright = d$end,ytop = i - 4, col = cols[as.character(rep("5",length(d[seq(1,length(d[,i]),2),i])))], border = NA)
}
abline(v = c(0, cumsum(chr.len)), col = "grey", lwd = 1)
dev.off()

png(paste(opt$out,"png",sep="."),height=900,width=1600);
plot(5, type = "n", xlim = c(0, max(d$end)), ylim = c(0,ncol(d) - 4), xaxt = "n",main="Haplotype",xlab=paste("LG",sep=" "),ylab="Samples")
axis(side = 1, at = x.brks, labels = unique(d$chr))
for (i in 4:ncol(d)) {
	if(colnames(d)[i]=="start"|| colnames(d)[i]=="end"){next}
    rect(xleft = d$start, ybottom = i - 5, xright = d$end,ytop = i - 4.6, col = cols[as.character(d[seq(0,length(d[,i]),2),i])], border = NA)
    rect(xleft = d$start, ybottom = i - 4.6, xright = d$end,ytop = i - 4.2, col = cols[as.character(d[seq(1,length(d[,i]),2),i])], border = NA)
    rect(xleft = d$start, ybottom = i - 4.2, xright = d$end,ytop = i - 4, col = cols[as.character(rep("5",length(d[seq(1,length(d[,i]),2),i])))], border = NA)
}
abline(v = c(0, cumsum(chr.len)), col = "grey", lwd = 1)
dev.off()


escaptime=Sys.time()-times;
print("Done!")
print(escaptime)
q();
